workflows:
  macos-sign-notarize-app:
    name: macOS Sign & Notarize .app Only
    max_build_duration: 60
    instance_type: mac_mini_m2

    environment:
      groups:
        - code-signing
      vars:
        BUNDLE_ID: "com.denice.agent.ai"
        XCODE_SCHEME: "AiAssistant"
        XCODE_WORKSPACE: "AiAssistant.xcworkspace"
      xcode: latest
      cocoapods: default

    integrations:
      app_store_connect: Denice-CI-CD-Key

    scripts:
      - name: Install CocoaPods dependencies
        script: pod install

      - name: Set up keychain for signing
        script: keychain initialize

      - name: Fetch Developer ID Application signing files
        script: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --platform MAC_OS \
            --type DEVELOPER_ID_APPLICATION \
            --create

      - name: Add certificates to keychain
        script: keychain add-certificates

      - name: Set up code signing in Xcode
        script: xcode-project use-profiles

      - name: Build the .app using Xcode
        script: |
          xcodebuild \
            -workspace "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -derivedDataPath build \
            clean build

      - name: Sign and notarize .app bundle
        script: |
          APP_PATH=$(find build -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "❌ ERROR: .app not found"
            exit 1
          fi

          echo "✅ Found app: $APP_PATH"
          
          # Sign the .app
          codesign --deep --force --verbose --options runtime \
            --sign "Developer ID Application: Angelle Denice (K9MTJ7767Q)" \
            "$APP_PATH"

          # Zip the app (required for notarization)
          ditto -c -k --keepParent "$APP_PATH" signed_app.zip

          # Submit to notarization
          xcrun notarytool submit signed_app.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --wait \
            --verbose

          echo "✅ Notarization submitted"

    artifacts:
      - build/**/*.app
      - signed_app.zip

    publishing:
      email:
        recipients:
          - esmondandersonhaldegallagher@gmail.com
        notify:
          success: true
          failure: true